<!DOCTYPE html>
<meta charset="utf-8">

<head>
	<title>Magnus Effect</title>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    
</head>

<body>
    <div class="title">
        <h2>Magnus Effect</h2>
        <br> 
    </div>
    
    <div class="row" id="magnusform">
        <div class="col-xs-6" id="graph">
        </div>
        <div class="col-xs-2">
            <form action="">
                <fieldset>
                    <legend>Independent Variables:</legend>
                    Launch Speed (m/s):<br>
                    <input type="number" name="launchspeed" value="70.0"><br>
                    Mass of Object (kg):<br>
                    <input type="number" name="mass" value="0.04593"><br>
                    Diameter of Object (m):<br>
                    <input type="number" name="diameter" value="0.04267"><br>
                    Launch Angle (Radians):<br>
                    <input type="number" name="angle" value="15"><br>
                    Rotations per Minute:<br>
                    <input type="number" name="rpm" value="2000"><br>
                    Initial Altitude (m):<br>
                    <input type="number" name="altitude" value="0.0"><br>
                    Air Density (kg/m^3):<br>
                    <input type="number" name="airdensity" value="1.2"><br>
                    Gravity (m/s^2):<br>
                    <input type="number" name="gravity" value="9.8"><br>

                </fieldset>
            </form>
            <br>
         </div>
         
         <div class="col-xs-3">
            <legend>Output:</legend>
            Final Velocity:
            <input type="text" name="finalvelocity" value=""><br>
            Total Displacement:
            <input type="text" name="displacement" value=""><br>
            Time Elapsed:
            <input type="text" name="totaltime" value=""><br>
         </div>
    </div>
    <br>
    <div>
        <div class="col-xs-6"></div>
        <div class="col-xs-2">
            <button type="button" class="btn btn-primary btn-lg" onclick="submit();">Generate</button>
        </div>
        
    </div>

</body>

<script>

    var color5 = ['#1f77b4','#ff7f0e','#2ca02c', '#d62728', '#9467bd'];
    var colorUsed = [false, false, false, false, false];
    
    function submit() {
        var launchspeed = parseFloat(document.getElementsByName("launchspeed")[0].value);
        var mass = parseFloat(document.getElementsByName("mass")[0].value);
        var diameter = parseFloat(document.getElementsByName("diameter")[0].value);
        var angle = parseFloat(document.getElementsByName("angle")[0].value);
        var rpm = parseFloat(document.getElementsByName("rpm")[0].value);
        var altitude = parseFloat(document.getElementsByName("altitude")[0].value);
        var airdensity = parseFloat(document.getElementsByName("airdensity")[0].value);
        var gravity = parseFloat(document.getElementsByName("gravity")[0].value);
        simulate(mass, diameter, altitude, launchspeed, angle, airdensity, gravity, rpm);
    }

    Math.radians = function(deg) {
        return deg * (Math.PI/180);
    }
    
    var argArr = new Array();
    function simulate(m, d, z0, V0, theta0, airdensity, gravity, rpm) {
        console.log(colorUsed);
        // var m = 0.04593; // mass of golf ball (k)	
        // var d = 0.04267; // ball diameter (m)
        // var z0 = 0.0 // Initial altitude (m)
        // var V0 = 70.0 // Launch speed (m/s)
        // var theta0 = Math.radians(15); // Launch angle (15 degrees coverted to radians)
        if (colorUsed.indexOf(false) == -1) {
            alert("You have exceeded the maximum number of concurrent simulations. Please remove an existing simulation before adding another.");
            console.log("alerrrt");
            return null;
        }
        console.log("SIMULATE RUNNING");
        theta0 = Math.radians(theta0);
        
        var h = 0.1; // Time step (s)
        var g = gravity; // Gravity (m/s^2)
        var dens = airdensity // Air density (kg/m^3)

        var A = Math.PI * Math.pow((d/2.), 2); // Cross-sectional area of golf ball (m^2)

        var x0 = 0.0 // Initial horitzontal distance (m)
        
        var u0 = V0 * Math.cos(theta0); // Initial horitzontal speed (m/s)
        var w0 = V0 * Math.sin(theta0); // Initial vertical speed (m/s)

        function getSpinRatio(omega, V) {
            // Python is: R = omega*(d/2.)/V 
            // Not sure what the 2. means but I think it just makes it a float, makes sense to meeee
            var R = omega * (d/parseFloat(2)) / V;
            if (R < 0.05 || R > 2) {
                console.log("Spin ratio outside of allowed range: " + R);
                return null;
            } else {
                return R;
            }
        }

        function getCD(omega, V) {
            R = getSpinRatio(omega, V);
            if (R == null) {
                return null;
            }
            return 0.1403 - 0.3406 * R * Math.log(R) + 0.3747 * Math.pow(R, 1.5);
        }

        function getCl(omega, V) {
            R = getSpinRatio(omega, V);
            if (R == null) {
                return null;
            }
            return 0.3396 + 0.1583 * Math.log(R) + 0.03790 * Math.pow(R, -0.5);
        }

        function getTrajectory(rpm) {
            var x = [x0, u0 * h + x0];
            var z = [z0, w0 * h + z0];
            var omega = 2 * Math.PI * rpm / 60;
            var cdArr = [0, getCD(omega, V0)];
            var clArr = [0, getCl(omega, V0)];
            var vArr = [0, V0];
            
            while (z[z.length - 1] > 0) {
                // console.log("%%%%%%%%%%% IN THE WHILE LOOP %%%%%%%%%%%%%%5");
                // get air speeds
                var u = (x[x.length - 1] - x[x.length - 2]) / h;
                var w = (z[z.length - 1] - z[z.length - 2]) / h;
                var V = Math.sqrt(Math.pow(u, 2) + Math.pow(w, 2));

                // get lift and drag coefficient
                var Cd = getCD(omega, V);
                var Cl = getCl(omega, V);

                // get next point in trajectory
                var xNext = -dens * A * V/(2*m) * (Cd * u + Cl * w) * Math.pow(h, 2) + 2 * x[x.length - 1] - x[x.length - 2];
                var znext = - (g + dens * A * V/(2*m) * (Cd * w - Cl * u)) * Math.pow(h, 2) + 2 * z[z.length - 1] - z[z.length - 2];

                // store the values
                x.push(xNext);
                z.push(znext);
                cdArr.push(Cd);
                clArr.push(Cl);
                vArr.push(V);
                // console.log(z[z.length - 1]);
            }
            
            // Convert to array and return
            var trajectory = [x, z, cdArr, clArr, vArr];
            return trajectory;
        }



        // Get trajectories for different rpm values
        var trajectory1 = getTrajectory(rpm);
        var x1 = trajectory1[0];
        var z1 = trajectory1[1];
        var cd1 = trajectory1[2];
        var cl1 = trajectory1[3];
        var vel1 = trajectory1[4];

        console.log(cd1);
        console.log(cl1);
        if (cd1.indexOf(null) != -1 || cl1.indexOf(null) != -1) {
            console.log("BOSBAOFHOAHFOS");
            alert("Spin ratio outside of allowed range");
            return null;
        } 
        
        //var argArr = new Array();
        for (i = 0; i < x1.length; i++) { 
            var jsonArg = new Object();
            jsonArg.xPosition = x1[i];
            jsonArg.zPosition = height - z1[i];
            jsonArg.timeStamp = i * h;
            jsonArg.cd = cd1[i];
            jsonArg.cl = cl1[i];
            jsonArg.vel = vel1[i];
            var colorInt = colorUsed.indexOf(false);
            jsonArg.dotColor = color5[colorInt];
            argArr.push(jsonArg);
        }
        colorUsed[colorInt] = true;
            
        // console.log(argArr);
        // TOTAL TIME
        var duration = x1.length * 0.01;
        // console.log(duration);
        
        draw(argArr);
    }

    //D3////////////////////////////
    
    //var colorUsed = [true, true, true, true, false];
    var margin = {top: 20, right: 20, bottom: 40, left: 40},
        width = 600 - margin.left - margin.right,
        height = 300 - margin.top - margin.bottom;

        
    var svg = d3.select("#graph").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .style("fill", "grey")
        .append("g")
        .attr("transform", 
            "translate(" + margin.left + "," + margin.top + ")");

    //accessing the variable
    var xAccess = function(d) { return d.xPosition; }
    var yAccess = function(d) { return d.zPosition; }

    //initialize scale
    var x = d3.scale.linear().domain([0,10]).range([0, width]);
    var y = d3.scale.linear().domain([0,10]).range([0, height]);
            
    function draw() {
        //rescale
        x.domain(d3.extent(argArr, xAccess));
        y.domain(d3.extent(argArr, yAccess));
        console.log('inside draw');

        var circles = svg.selectAll("circle").data(argArr);

        circles.transition()
            .duration(500)
            .style("fill", function(d) { return d.dotColor; })
            .attr("cx", function(d) { return x(d.xPosition); })
            .attr("cy", function(d) { return y(d.zPosition); })
            ;

        circles.enter()
            .append("circle")
            .style("fill", function(d) { return d.dotColor; })
            .attr("cx", function(d) { return x(d.xPosition); })
            .attr("cy", function(d) { return y(d.zPosition); })
            .attr("r", "3px")
            .attr('opacity', '0')
            .transition()
            // .duration(1)
            .delay(function(d, i) { return i*10; })
            .attr('opacity', '0.4');
    
        circles.exit()
            .transition()
            .duration(500)
            .attr('opacity', '0')
            .remove();
            
    }

    function removeSimulation(color) {
       var newArray = argArr.filter(function( obj ) {
            return obj.dotColor != color;
       });
       argArr = newArray;
       colorUsed[color5.indexOf(color)] = false;
       draw(argArr);
    }

    function reset() {
        argArr = [];
        draw();
    }
    

</script>
	
</html>

